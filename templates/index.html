{% extends 'layout.html' %}

{% block body %}
<div class="container mt-5 d-flex align-items-center justify-content-center flex-column">
    <h1>Dart Score Tracker</h1>
    {% if user_id %}
    <span>You are logged in as {{ user_name.capitalize() }}.</span>
    <h3 class="mt-5 mb-3 mx-4">Latest Matches</h3>

    <table class="table table-striped table-dark table-hover border-top" style="max-height: 400px; opacity: 0.8;">
        <thead class="text-center">
            <tr>
                <th>Winner</th>
                <th>Loser</th>
                <th>Score</th>
                <th>Date</th>
            </tr>
        </thead>
        <tbody class="text-center">
            
        </tbody>
    </table>

    <div id="pagination" class="mt-3"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            loadMatches(1); // Load first page on start
        });

        async function loadMatches(page = 1) {
            try {
                const response = await fetch(`/matches?page=${page}`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to fetch matches.');
                }

                const data = await response.json();
                const matches = data.matches;

                let html = '';
                for (let match of matches) {
                    html += `
                        <tr>
                            <td>${match.winner?.capitalize() || 'N/A'}</td>
                            <td>${match.loser?.capitalize() || 'N/A'}</td>
                            <td>${match.score}</td>
                            <td>${match.date}</td>
                        </tr>
                    `;
                }
                document.querySelector('tbody').innerHTML = html;

                // Render pagination buttons
                let paginationHtml = '';
                for (let i = 1; i <= data.total_pages; i++) {
                    if (i === data.page) {
                        paginationHtml += `<button disabled class="btn btn-secondary mx-1">${i}</button>`;
                    } else {
                        paginationHtml += `<button onclick="loadMatches(${i})" class="btn btn-primary mx-1">${i}</button>`;
                    }
                }
                document.getElementById('pagination').innerHTML = paginationHtml;

            } catch (error) {
                document.querySelector('tbody').innerHTML = `
                    <tr><td colspan="4">Error loading matches: ${error.message}</td></tr>
                `;
                console.error('Error fetching matches:', error);
            }
        }

        // Capitalize helper
        Object.defineProperty(String.prototype, 'capitalize', {
            value: function() { return this.charAt(0).toUpperCase() + this.slice(1); },
            enumerable: false
        });
    </script>

    {% else %}
        <span>Click <a href="/login">here</a> to login.</span>
    {% endif %}
</div>
{% endblock %}
